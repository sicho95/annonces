<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isochrone Immo (ORS Direct + Proxy Leboncoin)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #1877f2; text-align: center; margin-bottom: 25px; font-size: 1.8rem; }
        .section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e4e6eb; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #4b4f56; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccd0d5; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background-color: #1877f2; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #166fe5; }
        button:disabled { background-color: #e4e6eb; color: #bcc0c4; cursor: not-allowed; }
        #status { padding: 15px; margin-top: 15px; border-radius: 6px; display: none; text-align: center; }
        .loading { background-color: #e7f3ff; color: #1877f2; }
        .success { background-color: #e4f7eb; color: #0f7b3b; }
        .error { background-color: #ffebe8; color: #c92a2a; }
        #map { height: 550px; width: 100%; margin-top: 25px; border-radius: 8px; display: none; }
        #results-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-top: 10px; }
        #results-list li { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .badge-valid { background: #e4f7eb; color: #0f7b3b; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-invalid { background: #f0f2f5; color: #65676b; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .csv-btn { display: inline-block; width: 100%; margin-top: 10px; padding: 12px; background-color: #42b72a; color: white; text-decoration: none; border-radius: 6px; text-align: center; font-weight: bold; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìç Filtre Immo Isochrone</h1>

    <div class="section">
        <label>1. Isochrone (OpenRouteService)</label>
        <input type="text" id="address" value="19 Rue Paul Rivet, 92350 Le Plessis-Robinson">
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;"><label>Temps (min)</label><input type="number" id="duration" value="60"></div>
            <div style="flex: 1;">
                <label>Mode</label>
                <select id="profile">
                    <option value="driving-car">Voiture</option>
                    <option value="foot-walking">Pi√©ton</option>
                </select>
            </div>
        </div>
    </div>

    <div class="section">
        <label>2. Recherche (Leboncoin)</label>
        <input type="text" id="url" value="https://www.leboncoin.fr/recherche?category=9&locations=Le_Plessis-Robinson_92350">
        <button id="runBtn" onclick="runAnalysis()">üöÄ Lancer l'analyse</button>
        <div id="status"></div>
    </div>

    <div id="results-area" style="display:none;">
        <h3>R√©sultats filtr√©s</h3>
        <ul id="results-list"></ul>
        <a id="downloadLink" class="csv-btn" href="#">üì• T√©l√©charger CSV</a>
    </div>
    
    <div id="map"></div>
</div>

<script>
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';
    const ORS_API_URL = 'https://api.openrouteservice.org/v2/isochrones/';
    const ORS_KEY = '5b3ce3597851110001cf6248c89288e1781447039577239201089947'; // Cl√© Publique Gratuite
    
    // Proxy Worker pour Leboncoin UNIQUEMENT
    const PROXY_BASE = 'https://proxy.sicho95.workers.dev/';
    const getProxyUrl = (url) => `${PROXY_BASE}?url=${encodeURIComponent(url)}&_t=${Date.now()}`;

    let map = null, isochronePolygon = null;

    function updateStatus(msg, type) {
        const el = document.getElementById('status');
        el.style.display = 'block';
        el.className = type;
        el.innerText = msg;
    }

    // 1. ISOCHRONE (DIRECT ORS - CORS OK)
    async function getIsochrone() {
        const address = document.getElementById('address').value;
        const duration = parseInt(document.getElementById('duration').value);
        const profile = document.getElementById('profile').value;

        updateStatus("G√©ocodage adresse...", "loading");
        const geoRes = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(address)}&format=json&limit=1`).then(r => r.json());
        if (!geoRes.length) throw new Error("Adresse introuvable");
        const [lon, lat] = [parseFloat(geoRes[0].lon), parseFloat(geoRes[0].lat)];

        updateStatus("Calcul isochrone (ORS Direct)...", "loading");
        
        // Appel Direct (headers Auth g√©r√©s par le navigateur)
        const res = await fetch(`${ORS_API_URL}${profile}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': ORS_KEY
            },
            body: JSON.stringify({
                locations: [[lon, lat]],
                range: [duration * 60],
                range_type: "time"
            })
        });

        if (!res.ok) throw new Error(`Erreur ORS: ${res.status} (V√©rifiez la cl√© ou les quotas)`);
        isochronePolygon = await res.json();
        return isochronePolygon;
    }

    // 2. SCRAPING LEBONCOIN (VIA PROXY)
    async function getCommunesFromUrl() {
        const url = document.getElementById('url').value;
        updateStatus("Scraping Leboncoin (via Proxy)...", "loading");
        const communes = new Set();

        for (let p = 1; p <= 2; p++) {
            let pageUrl = url + (url.includes('?') ? '&' : '?') + `page=${p}`;
            try {
                // Ici on utilise le proxy car LBC bloque le direct
                const html = await fetch(getProxyUrl(pageUrl)).then(r => r.text());
                const text = new DOMParser().parseFromString(html, "text/html").body.innerText.toLowerCase();
                
                // Regex "Ville (CP)"
                for (const m of text.matchAll(/([a-zA-Z√Ä-√ø]+(?:[\s-][a-zA-Z√Ä-√ø]+)*)\s+(\d{5})/g)) {
                    let city = m[1].trim();
                    if (city.length > 2 && !city.includes('http')) {
                        communes.add(city.charAt(0).toUpperCase() + city.slice(1));
                    }
                }
            } catch (e) { console.warn("Erreur page " + p, e); }
        }
        
        const res = Array.from(communes).slice(0, 50);
        if (!res.length) throw new Error("Aucune ville trouv√©e (Proxy bloqu√© ?)");
        return res;
    }

    // 3. MAIN
    async function runAnalysis() {
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        try {
            await getIsochrone();
            const cities = await getCommunesFromUrl();
            
            updateStatus(`Filtrage de ${cities.length} villes...`, "loading");
            const valid = [];
            document.getElementById('results-area').style.display = 'block';
            document.getElementById('results-list').innerHTML = '';

            // Init Map
            if (!map) {
                document.getElementById('map').style.display = 'block';
                map = L.map('map').setView([46, 2], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            map.eachLayer(l => !l._url && map.removeLayer(l));
            
            L.geoJSON(isochronePolygon, {style: {color: '#1877f2', fillOpacity: 0.2}}).addTo(map);
            map.fitBounds(L.geoJSON(isochronePolygon).getBounds());

            for (const city of cities) {
                // Nominatim (Direct)
                const geo = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(city + ", France")}&format=json&limit=1`).then(r => r.json());
                if (geo.length) {
                    const [lat, lon] = [parseFloat(geo[0].lat), parseFloat(geo[0].lon)];
                    const isInside = turf.booleanPointInPolygon(turf.point([lon, lat]), isochronePolygon);
                    
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${city}</span> <span class="${isInside ? 'badge-valid' : 'badge-invalid'}">${isInside ? '‚úÖ OK' : 'Hors zone'}</span>`;
                    document.getElementById('results-list').appendChild(li);

                    if (isInside) {
                        L.marker([lat, lon]).addTo(map).bindPopup(city);
                        valid.push({name: city, lat, lon});
                    }
                }
                await new Promise(r => setTimeout(r, 1000)); // Rate limit
            }
            
            // CSV
            const csv = "data:text/csv;charset=utf-8,Ville,Lat,Lon%0A" + valid.map(c => `${c.name},${c.lat},${c.lon}`).join("%0A");
            document.getElementById('downloadLink').href = encodeURI(csv);
            document.getElementById('downloadLink').download = "resultats.csv";
            
            updateStatus(`Termin√© ! ${valid.length} villes valides.`, "success");
        } catch (e) {
            updateStatus("Erreur: " + e.message, "error");
        }
        btn.disabled = false;
    }
</script>

</body>
</html>
