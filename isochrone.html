<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isochrone Immo (GH Premium)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #fecb00; text-align: center; margin-bottom: 25px; text-shadow: 1px 1px 0 #333; }
        .section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e4e6eb; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #4b4f56; }
        input[type="text"], select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccd0d5; border-radius: 6px; box-sizing: border-box; }
        input[type="range"] { padding: 0; margin-top: 10px; width: 100%; }
        .checkbox-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee; }
        .checkbox-group input { width: auto; margin: 0; cursor: pointer; }
        .checkbox-group label { margin: 0; cursor: pointer; }
        
        button { width: 100%; padding: 14px; background-color: #fecb00; color: #1c1e21; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #e5b600; }
        button:disabled { background-color: #e4e6eb; color: #bcc0c4; cursor: not-allowed; }
        
        #status { padding: 15px; margin-top: 15px; border-radius: 6px; display: none; text-align: center; font-weight: 500; }
        .loading { background-color: #fff8e1; color: #856404; }
        .success { background-color: #e4f7eb; color: #0f7b3b; }
        .error { background-color: #ffebe8; color: #c92a2a; }
        
        #map { height: 600px; width: 100%; margin-top: 25px; border-radius: 8px; display: none; }
        #results-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-top: 10px; }
        #results-list li { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .badge-valid { background: #e4f7eb; color: #0f7b3b; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-invalid { background: #f0f2f5; color: #65676b; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .csv-btn { display: inline-block; width: 100%; margin-top: 10px; padding: 12px; background-color: #42b72a; color: white; text-decoration: none; border-radius: 6px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìç Filtre Immo (GraphHopper Premium)</h1>

    <div class="section">
        <label>1. Configurer le Trajet</label>
        <input type="text" id="address" value="19 Rue Paul Rivet, 92350 Le Plessis-Robinson" placeholder="Adresse de d√©part">
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label>Temps max: <span id="timeVal" style="color:#666;">90 min</span></label>
                <input type="range" id="duration" value="90" min="10" max="180" oninput="document.getElementById('timeVal').innerText = this.value + ' min'">
            </div>
            
            <div style="flex: 1; min-width: 200px;">
                <label>Mode & API</label>
                <select id="apiSelect">
                    <option value="auto">‚ö° Auto (GraphHopper pr√©f√©r√©)</option>
                    <option value="graphhopper">üü¢ GraphHopper (Max 180min+)</option>
                    <option value="ors">üîµ OpenRouteService (Max 60min)</option>
                    <option value="valhalla">üü£ Valhalla (Backup)</option>
                </select>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="avoidTolls">
                    <label for="avoidTolls">üö´ √âviter les p√©ages (GraphHopper/Valhalla)</label>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <label>2. Zone de recherche (Annonces)</label>
        <label>Rayon de recherche: <span id="radVal" style="color:#666;">30 km</span></label>
        <input type="range" id="radius" value="30" min="5" max="100" step="5" oninput="document.getElementById('radVal').innerText = this.value + ' km'">
        
        <button id="runBtn" onclick="runAnalysis()">üöÄ Lancer l'analyse</button>
        <div id="status"></div>
    </div>

    <div id="results-area" style="display:none;">
        <h3>R√©sultats filtr√©s</h3>
        <ul id="results-list"></ul>
        <a id="downloadLink" class="csv-btn" href="#">üì• T√©l√©charger CSV</a>
    </div>
    
    <div id="map"></div>
</div>

<script>
    // --- CONFIGURATION ---
    const GH_API_KEY = '940ddac6-b9e1-4a3b-b530-53b5f25cc591'; // Votre Cl√©
    
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';
    const ORS_API_URL = 'https://api.openrouteservice.org/v2/isochrones/';
    const VALHALLA_API = 'https://valhalla1.openstreetmap.de/isochrone';
    const GH_API_URL = 'https://graphhopper.com/api/1/isochrone';
    const BIENICI_API = 'https://www.bienici.com/realEstateAds.json';
    
    const PROXY_BASE = 'https://proxy.sicho95.workers.dev/';
    const getProxyUrl = (url) => `${PROXY_BASE}?url=${encodeURIComponent(url)}&_t=${Date.now()}`;

    let map = null, isochronePolygon = null;
    let startLat = null, startLon = null;

    function updateStatus(msg, type) {
        const el = document.getElementById('status');
        el.style.display = 'block';
        el.className = type;
        el.innerHTML = msg;
    }

    // --- 1. ISOCHRONE (MULTI-API) ---
    async function getIsochrone() {
        const address = document.getElementById('address').value;
        const duration = parseInt(document.getElementById('duration').value);
        const avoidTolls = document.getElementById('avoidTolls').checked;
        const apiChoice = document.getElementById('apiSelect').value;

        updateStatus("G√©ocodage...", "loading");
        const geoRes = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(address)}&format=json&limit=1`).then(r => r.json());
        if (!geoRes || geoRes.length === 0) throw new Error("Adresse introuvable");
        startLat = parseFloat(geoRes[0].lat);
        startLon = parseFloat(geoRes[0].lon);

        // LOGIQUE DE S√âLECTION
        let selectedApi = apiChoice;
        if (apiChoice === 'auto') {
            // Priorit√© GraphHopper (plus puissant, cl√© dispo)
            // Sauf si < 60min et simple (ORS plus rapide parfois)
            if (duration <= 60 && !avoidTolls) selectedApi = 'ors';
            else selectedApi = 'graphhopper'; 
        }

        updateStatus(`Calcul isochrone (${selectedApi.toUpperCase()})...`, "loading");
        let geoJson = null;

        // --- API 1: GRAPH HOPPER (PREMIUM KEY) ---
        if (selectedApi === 'graphhopper') {
            try {
                // GraphHopper Isochrone
                let url = `${GH_API_URL}?point=${startLat},${startLon}&time_limit=${duration*60}&profile=car&key=${GH_API_KEY}`;
                
                // GH Free/Standard Isochrone supporte mal 'avoid' direct dans l'URL standard isochrone
                // Mais on peut tenter de passer via profile 'car' standard qui est souvent optimis√©
                // Si besoin de custom_model (tolls), √ßa demande l'endpoint /custom, plus complexe.
                // Ici on reste sur l'appel standard qui est tr√®s robuste.
                
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Erreur GraphHopper (${res.status})`);
                const json = await res.json();
                
                if (json.polygons) {
                    geoJson = {
                        type: "FeatureCollection",
                        features: json.polygons.map(p => ({
                            type: "Feature",
                            geometry: p.geometry,
                            properties: p.properties
                        }))
                    };
                }
            } catch (e) { 
                console.warn("Echec GH, tentative Valhalla...", e);
                selectedApi = 'valhalla'; // Fallback automatique
            }
        }

        // --- API 2: OPENROUTE SERVICE (Max 60) ---
        if (selectedApi === 'ors') {
            try {
                const res = await fetch(getProxyUrl(`${ORS_API_URL}driving-car`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        locations: [[startLon, startLat]],
                        range: [duration * 60],
                        range_type: "time"
                    })
                });
                if (!res.ok) throw new Error(`Erreur ORS (${res.status})`);
                geoJson = await res.json();
            } catch (e) { throw new Error("Erreur ORS: " + e.message); }
        }
        
        // --- API 3: VALHALLA (Fallback) ---
        if (selectedApi === 'valhalla') {
            try {
                const costingOptions = {};
                if (avoidTolls) {
                    costingOptions.auto = { use_tolls: 0, toll_booth_penalty: 2000 };
                }
                const res = await fetch(getProxyUrl(VALHALLA_API), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        locations: [{lat: startLat, lon: startLon}],
                        costing: 'auto',
                        costing_options: costingOptions,
                        contours: [{time: duration}], 
                        polygons: true
                    })
                });
                if (!res.ok) throw new Error(`Erreur Valhalla (${res.status})`);
                const json = await res.json();
                if (json.features) geoJson = { type: "FeatureCollection", features: json.features };
            } catch (e) { throw new Error("Erreur Valhalla: " + e.message); }
        }

        if (!geoJson || !geoJson.features) throw new Error("Aucun isochrone re√ßu.");
        isochronePolygon = geoJson;
        return isochronePolygon;
    }

    // --- 2. BIEN'ICI ---
    async function getCommunesFromBienici() {
        const radiusKm = parseInt(document.getElementById('radius').value);
        updateStatus(`Recherche Bien'ici (Rayon ${radiusKm}km)...`, "loading");
        const communes = new Set();
        const filters = {
            filterType: "buy",
            propertyType: ["house", "flat"],
            page: 1, resultsPerPage: 100, maxAuthorizedResults: 2000,
            onTheMarket: [true],
            lat: startLat, lng: startLon, radius: radiusKm * 1000
        };

        try {
            const res = await fetch(getProxyUrl(`${BIENICI_API}?filters=${encodeURIComponent(JSON.stringify(filters))}`));
            if (!res.ok) throw new Error(`Erreur Bien'ici (${res.status})`);
            const data = await res.json();
            if (data.realEstateAds) data.realEstateAds.forEach(ad => { if (ad.city) communes.add(ad.city); });
        } catch (e) { console.warn(e); throw new Error("Erreur Bien'ici."); }
        
        return Array.from(communes);
    }

    // --- 3. MAIN ---
    async function runAnalysis() {
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        try {
            if (map) { map.remove(); map = null; }
            await getIsochrone();
            const cities = await getCommunesFromBienici();
            
            updateStatus(`Filtrage de ${cities.length} villes...`, "loading");
            const valid = [];
            
            document.getElementById('results-area').style.display = 'block';
            document.getElementById('results-list').innerHTML = '';
            document.getElementById('map').style.display = 'block';
            
            map = L.map('map').setView([startLat, startLon], 9);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            const color = document.getElementById('avoidTolls').checked ? '#e74c3c' : '#fecb00'; 
            L.geoJSON(isochronePolygon, {style: {color: color, fillColor: color, fillOpacity: 0.2}}).addTo(map);
            
            const radiusKm = parseInt(document.getElementById('radius').value);
            L.circle([startLat, startLon], {radius: radiusKm * 1000, color: 'gray', fill: false, dashArray: '5, 5'}).addTo(map);
            map.fitBounds(L.geoJSON(isochronePolygon).getBounds());

            for (const city of cities) {
                try {
                    const geo = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(city + ", France")}&format=json&limit=1`).then(r => r.json());
                    if (geo && geo.length) {
                        const [lat, lon] = [parseFloat(geo[0].lat), parseFloat(geo[0].lon)];
                        const pt = turf.point([lon, lat]);
                        let isInside = false;
                        if (isochronePolygon.features) {
                            for (const feature of isochronePolygon.features) {
                                if (turf.booleanPointInPolygon(pt, feature)) { isInside = true; break; }
                            }
                        }
                        const li = document.createElement('li');
                        if (isInside) {
                            li.innerHTML = `<span>${city}</span> <span class="badge-valid">‚úÖ OK</span>`;
                            L.marker([lat, lon]).addTo(map).bindPopup(city);
                            valid.push({name: city, lat, lon});
                        } else {
                            li.innerHTML = `<span>${city}</span> <span class="badge-invalid">Hors</span>`;
                        }
                        document.getElementById('results-list').appendChild(li);
                    }
                } catch (e) {}
                await new Promise(r => setTimeout(r, 200));
            }
            
            const csv = "text/csv;charset=utf-8,Ville,Lat,Lon%0A" + valid.map(c => `${c.name},${c.lat},${c.lon}`).join("%0A");
            document.getElementById('downloadLink').href = encodeURI(csv);
            document.getElementById('downloadLink').download = "resultats.csv";
            updateStatus(`Termin√© ! ${valid.length} villes trouv√©es.`, "success");
        } catch (e) {
            updateStatus("Erreur: " + e.message, "error");
        }
        btn.disabled = false;
    }
</script>

</body>
</html>
