<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chasseur Immo (Filtres + Isochrone)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e4e6eb; }
        h3 { margin-top: 0; color: #444; font-size: 1.1em; }
        
        /* Grid pour les filtres */
        .grid-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #4b4f56; font-size: 0.9em; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccd0d5; border-radius: 6px; box-sizing: border-box; }
        input[type="range"] { width: 100%; margin-top: 5px; }
        
        .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .checkbox-group input { width: auto; margin: 0; cursor: pointer; }
        
        button { width: 100%; padding: 14px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #e4e6eb; color: #bcc0c4; cursor: not-allowed; }
        
        #status { padding: 15px; margin-top: 15px; border-radius: 6px; display: none; text-align: center; font-weight: 500; border: 1px solid transparent; }
        .info { background-color: #e3f2fd; color: #0d47a1; border-color: #bbdefb; }
        .success { background-color: #e8f5e9; color: #1b5e20; border-color: #c8e6c9; }
        .error { background-color: #ffebee; color: #b71c1c; border-color: #ffcdd2; }
        
        #map { height: 550px; width: 100%; margin-top: 25px; border-radius: 8px; display: none; }
        #results-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-top: 10px; }
        #results-list li { padding: 8px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .badge-valid { background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .badge-count { background: #eee; color: #555; padding: 3px 8px; border-radius: 10px; font-size: 0.85em; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üè° Chasseur Immo Intelligent</h1>

    <!-- SECTION 1 : CRIT√àRES BIEN -->
    <div class="section">
        <h3>1. Crit√®res du Bien (Filtres Bien'ici)</h3>
        <div class="grid-filters">
            <div>
                <label>Budget Max (‚Ç¨)</label>
                <input type="number" id="maxPrice" placeholder="Ex: 450000" step="5000">
            </div>
            <div>
                <label>Surface Min (m¬≤)</label>
                <input type="number" id="minArea" placeholder="Ex: 80" step="5">
            </div>
            <div>
                <label>Pi√®ces Min</label>
                <input type="number" id="minRooms" placeholder="Ex: 3">
            </div>
            <div>
                <label>Type de bien</label>
                <div style="margin-top:5px;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="typeHouse" checked> <label for="typeHouse">Maison</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="typeFlat" checked> <label for="typeFlat">Appartement</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION 2 : TRAJET -->
    <div class="section">
        <h3>2. Contrainte G√©ographique (Isochrone)</h3>
        <input type="text" id="address" value="19 Rue Paul Rivet, 92350 Le Plessis-Robinson" placeholder="Adresse Travail / Point de d√©part">
        
        <div class="grid-filters" style="margin-top:15px;">
            <div>
                <label>Temps Max: <span id="timeVal" style="color:#d32f2f; font-weight:bold;">90 min</span></label>
                <input type="range" id="duration" value="90" min="10" max="100" oninput="updateTimeColor(this.value)">
                <small id="timeMsg" style="color:#666; font-size:0.8em;">Mode: Valhalla (Simplifi√©)</small>
            </div>
            <div>
                <label>Rayon de recherche: <span id="radVal">30 km</span></label>
                <input type="range" id="radius" value="30" min="5" max="80" step="5" oninput="document.getElementById('radVal').innerText = this.value + ' km'">
            </div>
        </div>

        <button id="runBtn" onclick="runAnalysis()">üöÄ Lancer la recherche</button>
        <div id="status"></div>
    </div>

    <div id="results-area" style="display:none;">
        <h3>R√©sultats</h3>
        <div style="font-size: 0.9em; margin-bottom: 5px; color: #666;">
            Villes dans la zone : <b id="valid-count">0</b>
        </div>
        <ul id="results-list"></ul>
    </div>
    
    <div id="map"></div>
</div>

<script>
    // --- CONFIG ---
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';
    const ORS_API_URL = 'https://api.openrouteservice.org/v2/isochrones/';
    const VALHALLA_API = 'https://valhalla1.openstreetmap.de/isochrone';
    const BIENICI_API = 'https://www.bienici.com/realEstateAds.json';
    
    const PROXY_BASE = 'https://proxy.sicho95.workers.dev/';
    const getProxyUrl = (url) => `${PROXY_BASE}?url=${encodeURIComponent(url)}&_t=${Date.now()}`;

    let map = null, isochronePolygon = null;
    let startLat = null, startLon = null;

    // --- UI HELPERS ---
    function updateTimeColor(val) {
        const el = document.getElementById('timeVal');
        const msg = document.getElementById('timeMsg');
        el.innerText = val + ' min';
        
        if (val <= 60) {
            el.style.color = '#2e7d32'; // Vert
            msg.innerText = "Mode: ORS (Pr√©cis)";
        } else {
            el.style.color = '#d32f2f'; // Rouge
            msg.innerText = "Mode: Valhalla (Longue distance)";
        }
    }

    function updateStatus(msg, type) {
        const el = document.getElementById('status');
        el.style.display = 'block';
        el.className = type;
        el.innerHTML = msg;
        console.log(`[STATUS] ${msg}`);
    }

    // --- 1. ISOCHRONE (Trajet) ---
    async function getIsochrone() {
        const address = document.getElementById('address').value;
        const duration = parseInt(document.getElementById('duration').value);

        updateStatus("üìç G√©ocodage de l'adresse de d√©part...", "info");
        const geoRes = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(address)}&format=json&limit=1`).then(r => r.json());
        if (!geoRes || geoRes.length === 0) throw new Error("Adresse de d√©part introuvable.");
        startLat = parseFloat(geoRes[0].lat);
        startLon = parseFloat(geoRes[0].lon);

        let geoJson = null;

        if (duration <= 60) {
            updateStatus(`üöó Calcul isochrone ORS (${duration} min)...`, "info");
            try {
                const res = await fetch(getProxyUrl(`${ORS_API_URL}driving-car`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        locations: [[startLon, startLat]],
                        range: [duration * 60],
                        range_type: "time"
                    })
                });
                if (!res.ok) throw new Error(`Erreur ORS (${res.status})`);
                geoJson = await res.json();
            } catch (e) { throw e; }
        } else {
            updateStatus(`üöô Calcul isochrone Valhalla (${duration} min)...`, "info");
            try {
                // Version SANS denoise pour max pr√©cision
                const body = {
                    locations: [{lat: startLat, lon: startLon}],
                    costing: 'auto',
                    contours: [{ time: duration, color: "ff0000" }],
                    polygons: true
                };
                const res = await fetch(getProxyUrl(VALHALLA_API), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error(`Erreur Valhalla (${res.status})`);
                const json = await res.json();
                if (json.features) geoJson = { type: "FeatureCollection", features: json.features };
            } catch (e) { throw e; }
        }

        if (!geoJson || !geoJson.features) throw new Error("Impossible de g√©n√©rer la zone de trajet.");
        isochronePolygon = geoJson;
        return isochronePolygon;
    }

    // --- 2. BIEN'ICI (Annonces) ---
    async function getCommunesFromBienici() {
        const radiusKm = parseInt(document.getElementById('radius').value);
        
        // R√©cup√©ration des filtres UI
        const maxPrice = document.getElementById('maxPrice').value;
        const minArea = document.getElementById('minArea').value;
        const minRooms = document.getElementById('minRooms').value;
        const typeHouse = document.getElementById('typeHouse').checked;
        const typeFlat = document.getElementById('typeFlat').checked;

        const propertyTypes = [];
        if (typeHouse) propertyTypes.push("house");
        if (typeFlat) propertyTypes.push("flat");

        if (propertyTypes.length === 0) throw new Error("Veuillez s√©lectionner au moins un type de bien (Maison/Appart).");

        // Construction du filtre API
        const filters = {
            filterType: "buy",
            propertyType: propertyTypes,
            page: 1, 
            resultsPerPage: 2000, // On essaie de tout prendre d'un coup
            maxAuthorizedResults: 2000,
            onTheMarket: [true],
            lat: startLat, 
            lng: startLon, 
            radius: radiusKm * 1000 // Bien'ici parle en m√®tres
        };

        // Ajout conditionnel des filtres (ne pas envoyer si vide)
        if (maxPrice) filters.maxPrice = parseInt(maxPrice);
        if (minArea) filters.minArea = parseInt(minArea);
        if (minRooms) filters.minRooms = parseInt(minRooms);
        // Pour le DPE, l'API utilise energyClassification: ["A", "B", ...] mais c'est lourd √† g√©rer en UI simple.

        updateStatus(`üîç Recherche Bien'ici (Rayon ${radiusKm}km)...`, "info");
        console.log("Filtres envoy√©s:", filters);

        let adsFound = [];
        
        try {
            const url = `${BIENICI_API}?filters=${encodeURIComponent(JSON.stringify(filters))}`;
            const res = await fetch(getProxyUrl(url));
            
            if (!res.ok) throw new Error(`Erreur HTTP Bien'ici (${res.status})`);
            
            const data = await res.json();
            
            if (!data.realEstateAds) {
                // Parfois le proxy ou l'API renvoie un JSON valide mais vide ou une erreur
                console.warn("R√©ponse suspecte:", data);
                throw new Error("Structure de r√©ponse Bien'ici invalide.");
            }

            adsFound = data.realEstateAds;
            updateStatus(`‚úÖ Bien'ici a r√©pondu : <b>${adsFound.length} annonces</b> trouv√©es AVANT filtrage trajet.`, "success");

            if (adsFound.length === 0) {
                throw new Error("Aucune annonce trouv√©e avec ces crit√®res (Budget/Surface). √âlargissez vos filtres.");
            }

        } catch (e) {
            console.error(e);
            throw new Error(`Erreur r√©cup√©ration annonces : ${e.message}`);
        }
        
        // Aggr√©gation par ville
        const communes = new Map(); // Map: "Ville" => Nombre d'annonces
        adsFound.forEach(ad => {
            if (ad.city) {
                const city = ad.city;
                communes.set(city, (communes.get(city) || 0) + 1);
            }
        });
        
        return communes;
    }

    // --- 3. EXECUTION ---
    async function runAnalysis() {
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        document.getElementById('results-area').style.display = 'none';
        document.getElementById('map').style.display = 'none';

        try {
            if (map) { map.remove(); map = null; }
            
            // √âtape 1 : Isochrone
            await getIsochrone();
            
            // √âtape 2 : Annonces (avec filtres)
            // On attend 1 seconde pour √™tre s√ªr que les logs s'affichent
            await new Promise(r => setTimeout(r, 500));
            const communesMap = await getCommunesFromBienici();
            
            updateStatus(`üìê Croisement des donn√©es (Trajet vs ${communesMap.size} villes)...`, "info");
            
            // √âtape 3 : Affichage
            document.getElementById('results-area').style.display = 'block';
            document.getElementById('map').style.display = 'block';
            document.getElementById('results-list').innerHTML = '';
            
            map = L.map('map').setView([startLat, startLon], 9);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            const duration = parseInt(document.getElementById('duration').value);
            const color = duration <= 60 ? '#2e7d32' : '#d32f2f';
            L.geoJSON(isochronePolygon, {style: {color: color, fillColor: color, fillOpacity: 0.2}}).addTo(map);
            
            const radiusKm = parseInt(document.getElementById('radius').value);
            L.circle([startLat, startLon], {radius: radiusKm * 1000, color: '#666', fill: false, dashArray: '5, 5'}).addTo(map);
            map.fitBounds(L.geoJSON(isochronePolygon).getBounds());

            let validCount = 0;
            const citiesArray = Array.from(communesMap.keys());

            // Boucle sur les villes pour v√©rifier si elles sont dans la zone
            for (const city of citiesArray) {
                try {
                    // On g√©ocode la ville pour savoir si son centre est dans l'isochrone
                    const geo = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(city + ", France")}&format=json&limit=1`).then(r => r.json());
                    
                    if (geo && geo.length) {
                        const [lat, lon] = [parseFloat(geo[0].lat), parseFloat(geo[0].lon)];
                        const pt = turf.point([lon, lat]);
                        
                        let isInside = false;
                        if (isochronePolygon.features) {
                            for (const feature of isochronePolygon.features) {
                                if (turf.booleanPointInPolygon(pt, feature)) { isInside = true; break; }
                            }
                        }

                        if (isInside) {
                            validCount++;
                            const nbAds = communesMap.get(city);
                            
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <div>
                                    <b>${city}</b>
                                    <span class="badge-count">${nbAds} annonce(s)</span>
                                </div>
                                <span class="badge-valid">‚úÖ OK</span>
                            `;
                            document.getElementById('results-list').appendChild(li);
                            
                            // Marqueur sur la carte
                            L.marker([lat, lon])
                                .addTo(map)
                                .bindPopup(`<b>${city}</b><br>${nbAds} annonce(s) correspondante(s)`);
                        }
                    }
                } catch (e) { console.error(e); }
                
                // Petite pause pour √©viter de bloquer le navigateur
                await new Promise(r => setTimeout(r, 50));
            }
            
            document.getElementById('valid-count').innerText = validCount;
            updateStatus(`Termin√© ! ${validCount} villes matchant vos crit√®res et le trajet.`, "success");

        } catch (e) {
            updateStatus("ERREUR BLOQUANTE : " + e.message, "error");
        }
        btn.disabled = false;
    }
</script>

</body>
</html>
