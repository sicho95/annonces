<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chasseur Immo V13 (Tol√©rance)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f2f2f7; color: #1c1c1e; margin: 0; padding: 15px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: #007aff; text-align: center; margin-bottom: 20px; font-size: 1.4em; }
        
        .section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e5ea; }
        h3 { margin-top: 0; color: #3a3a3c; font-size: 1.1em; font-weight: 600; margin-bottom: 15px; }
        
        .grid-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #8e8e93; font-size: 0.85em; text-transform: uppercase; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        
        .check-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .check-pill { display: flex; align-items: center; background: #f2f2f7; padding: 8px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 600; cursor: pointer; }
        .check-pill input { margin-right: 8px; transform: scale(1.2); }

        .slider-group { margin-bottom: 20px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        input[type="range"] { width: 100%; height: 6px; border-radius: 5px; background: #e5e5ea; outline: none; -webkit-appearance: none; display: block; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #007aff; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        button { width: 100%; padding: 16px; background-color: #007aff; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 17px; margin-top: 10px; }
        button:disabled { background-color: #d1d1d6; }

        #console-log { background: #1c1c1e; color: #30d158; padding: 15px; border-radius: 10px; margin-top: 15px; height: 120px; overflow-y: auto; font-family: monospace; font-size: 0.75em; }

        #results-list { list-style: none; padding: 0; max-height: 500px; overflow-y: auto; }
        #results-list li { 
            background: white; border: 1px solid #e5e5ea; border-radius: 12px; 
            padding: 15px; margin-bottom: 10px; display: flex; 
            justify-content: space-between; align-items: center; 
        }
        
        .badge-ok { background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; }
        .badge-warn { background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; }
        .badge-lim { background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; }

        .btn-see { background: #eef2ff; color: #007aff; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        
        #details-panel { display: none; border-top: 2px solid #e5e5ea; margin-top: 20px; padding-top: 20px; }
        .ad-card { display: flex; gap: 15px; background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        .ad-img { width: 90px; height: 70px; background: #eee; border-radius: 6px; object-fit: cover; }
        .ad-info { flex: 1; }
        .ad-price { font-weight: bold; color: #007aff; }
        .ad-link { display: inline-block; margin-top: 5px; font-size: 0.8em; color: #fff; background: #333; padding: 4px 10px; border-radius: 4px; text-decoration: none; }

        #map { height: 350px; width: 100%; margin-top: 20px; border-radius: 16px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üéØ Chasseur Immo V13</h1>

    <div class="section">
        <h3>1. Vos Crit√®res</h3>
        <div class="grid-filters">
            <div><label>Budget Max (‚Ç¨)</label><input type="number" id="maxPrice" value="145000" step="5000"></div>
            <div><label>Surface Min (m¬≤)</label><input type="number" id="minArea" value="100" step="5"></div>
            <div><label>Pi√®ces Min</label><input type="number" id="minRooms" value="5"></div>
        </div>
        
        <div class="check-grid">
            <label class="check-pill"><input type="checkbox" id="typeHouse" checked> Maison</label>
            <label class="check-pill"><input type="checkbox" id="typeFlat"> Appart</label>
            <label class="check-pill"><input type="checkbox" id="typeLand"> Terrain</label>
            <label class="check-pill"><input type="checkbox" id="typeBuilding"> Immeuble</label>
            <label class="check-pill"><input type="checkbox" id="typeLoft" checked> Loft/Atelier</label>
            <label class="check-pill"><input type="checkbox" id="typeCastle" checked> Ch√¢teau</label>
        </div>
    </div>

    <div class="section">
        <h3>2. Zone & Trajet</h3>
        <input type="text" id="address" value="19 Rue Paul Rivet, 92350 Le Plessis-Robinson">
        
        <div style="margin-top:15px; margin-bottom:20px;">
            <label class="check-pill" style="background:#ffebee; color:#b71c1c; display:inline-flex;">
                <input type="checkbox" id="avoidTolls"> üö´ √âviter les p√©ages
            </label>
        </div>

        <div class="slider-group">
            <div class="slider-header">
                <label>Trajet + Tol√©rance (+15%)</label>
                <span id="timeVal" style="color:#007aff; font-weight:bold;">90 min</span>
            </div>
            <input type="range" id="duration" value="90" min="10" max="120" oninput="document.getElementById('timeVal').innerText = this.value + ' min'">
        </div>

        <div class="slider-group">
            <div class="slider-header">
                <label>Rayon Scraping</label>
                <span id="radVal" style="color:#007aff; font-weight:bold;">250 km</span>
            </div>
            <input type="range" id="radius" value="250" min="50" max="300" step="10" oninput="document.getElementById('radVal').innerText = this.value + ' km'">
        </div>

        <button id="runBtn" onclick="runAnalysis()">üöÄ SCANNER TOUT</button>
        <div id="console-log">Pr√™t...</div>
    </div>

    <div id="results-area" style="display:none;">
        <h3>R√©sultats (<span id="final-count">0</span>)</h3>
        <ul id="results-list"></ul>
        <div id="details-panel">
            <h3 id="details-title">...</h3>
            <div id="details-content"></div>
        </div>
    </div>
    
    <div id="map"></div>
</div>

<script>
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';
    const ORS_API_URL = 'https://api.openrouteservice.org/v2/isochrones/';
    const VALHALLA_API = 'https://valhalla1.openstreetmap.de/isochrone';
    const BIENICI_API = 'https://www.bienici.com/realEstateAds.json';
    const PROXY_BASE = 'https://proxy.sicho95.workers.dev/';
    const getProxyUrl = (url) => `${PROXY_BASE}?url=${encodeURIComponent(url)}&_t=${Date.now()}`;

    let map = null, isochronePolygon = null;
    let startLat = null, startLon = null;
    let globalAds = [];
    let seenAds = new Set();

    function log(msg, type="info") {
        const el = document.getElementById('console-log');
        el.innerHTML += `<div style="color:${type==='error'?'#ff453a':(type==='success'?'#30d158':'#a1a1a6')}; margin-bottom:2px;">> ${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }

    // ON AJOUTE UNE ZONE TAMPON DE 15% DANS L'ISOCHRONE
    async function getIsochrone() {
        const address = document.getElementById('address').value;
        const baseDuration = parseInt(document.getElementById('duration').value);
        // ASTUCE : On demande un polygone un peu plus grand (+15%) pour la tol√©rance
        const duration = Math.round(baseDuration * 1.15); 
        
        const avoidTolls = document.getElementById('avoidTolls').checked;

        log(`G√©ocodage...`);
        const geoRes = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(address)}&format=json&limit=1`).then(r => r.json());
        if (!geoRes.length) throw new Error("Adresse introuvable");
        startLat = parseFloat(geoRes[0].lat);
        startLon = parseFloat(geoRes[0].lon);

        let geoJson = null;

        if (duration <= 60) {
            log(`Calcul ORS (Max ${duration} min)...`);
            const body = { 
                locations: [[startLon, startLat]], 
                range: [duration * 60], 
                range_type: "time"
            };
            if (avoidTolls) body.options = { avoid_features: ["tollways"] };

            try {
                const res = await fetch(getProxyUrl(`${ORS_API_URL}driving-car`), {
                    method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' }
                });
                geoJson = await res.json();
            } catch(e) { log("Erreur ORS", "error"); }

        } else {
            log(`Calcul Valhalla (Max ${duration} min)...`);
            const costingOpts = { auto: {} };
            if (avoidTolls) {
                costingOpts.auto.use_tolls = 0; 
                costingOpts.auto.toll_booth_penalty = 2000;
            }

            const body = { 
                locations: [{lat: startLat, lon: startLon}], 
                costing: 'auto', 
                costing_options: costingOpts,
                contours: [{ time: duration, color: avoidTolls ? "ff8800" : "007aff" }], 
                polygons: true 
            };
            
            try {
                const res = await fetch(getProxyUrl(VALHALLA_API), { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                const json = await res.json();
                if (json.features) geoJson = { type: "FeatureCollection", features: json.features };
            } catch(e) { log("Erreur Valhalla", "error"); }
        }
        return geoJson;
    }

    async function getAllAds() {
        const radiusKm = parseInt(document.getElementById('radius').value);
        let allAds = [];
        let page = 1;
        let hasMore = true;
        seenAds.clear();
        
        const filters = {
            filterType: "buy", propertyType: [],
            page: 1, resultsPerPage: 24, maxAuthorizedResults: 2000, onTheMarket: [true],
            lat: startLat, lng: startLon, radius: radiusKm * 1000
        };
        
        if (document.getElementById('typeHouse').checked) filters.propertyType.push("house");
        if (document.getElementById('typeFlat').checked) filters.propertyType.push("flat");
        if (document.getElementById('typeLand').checked) filters.propertyType.push("land");
        if (document.getElementById('typeBuilding').checked) filters.propertyType.push("building");
        if (document.getElementById('typeLoft').checked) filters.propertyType.push("loft");
        if (document.getElementById('typeCastle').checked) filters.propertyType.push("castle");
        
        if (document.getElementById('maxPrice').value) filters.maxPrice = parseInt(document.getElementById('maxPrice').value);
        if (document.getElementById('minArea').value) filters.minArea = parseInt(document.getElementById('minArea').value);
        if (document.getElementById('minRooms').value) filters.minRooms = parseInt(document.getElementById('minRooms').value);

        while (hasMore && page <= 30) { 
            filters.page = page;
            log(`Page ${page}...`);
            try {
                const res = await fetch(getProxyUrl(`${BIENICI_API}?filters=${encodeURIComponent(JSON.stringify(filters))}`));
                const data = await res.json();
                if (data.realEstateAds?.length > 0) {
                    const newAds = data.realEstateAds.filter(ad => {
                        if (seenAds.has(ad.id)) return false;
                        seenAds.add(ad.id);
                        return true;
                    });
                    allAds = allAds.concat(newAds);
                    page++;
                } else hasMore = false;
            } catch (e) { hasMore = false; }
            await new Promise(r => setTimeout(r, 100));
        }
        return allAds;
    }

    function showDetails(cityName) {
        const cityAds = globalAds.filter(ad => ad.city === cityName);
        const container = document.getElementById('details-content');
        document.getElementById('details-title').innerText = `${cityName} (${cityAds.length})`;
        container.innerHTML = '';
        cityAds.forEach(ad => {
            let imgHtml = '<div class="ad-img" style="background:#eee;"></div>';
            if (ad.photos?.[0]?.url) imgHtml = `<img src="${ad.photos[0].url}" class="ad-img" loading="lazy">`;
            container.insertAdjacentHTML('beforeend', `
                <div class="ad-card">
                    ${imgHtml}
                    <div class="ad-info">
                        <div class="ad-price">${ad.price?.toLocaleString()} ‚Ç¨</div>
                        <div style="font-size:0.9em;">${ad.surfaceArea}m¬≤ ‚Ä¢ ${ad.roomsQuantity}p</div>
                        <div style="font-size:0.8em; color:#666;">${ad.propertyType}</div>
                        <a href="https://www.bienici.com/annonce/${ad.id}" target="_blank" class="ad-link">Voir</a>
                    </div>
                </div>
            `);
        });
        document.getElementById('details-panel').style.display = 'block';
        document.getElementById('details-panel').scrollIntoView({behavior: "smooth"});
    }

    async function runAnalysis() {
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        document.getElementById('console-log').innerHTML = '';
        document.getElementById('details-panel').style.display = 'none';

        try {
            if (map) { map.remove(); map = null; }

            // 1. Zone
            isochronePolygon = await getIsochrone();
            
            // 2. Annonces
            globalAds = await getAllAds();
            if (globalAds.length === 0) throw new Error("0 annonce.");
            log(`${globalAds.length} annonces scann√©es.`, "success");

            const communesMap = new Map();
            globalAds.forEach(ad => { if (ad.city) communesMap.set(ad.city, (communesMap.get(ad.city) || 0) + 1); });

            document.getElementById('results-area').style.display = 'block';
            document.getElementById('map').style.display = 'block';
            document.getElementById('results-list').innerHTML = '';
            
            map = L.map('map').setView([startLat, startLon], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            const avoidTolls = document.getElementById('avoidTolls').checked;
            const color = avoidTolls ? '#d32f2f' : '#007aff';
            if (isochronePolygon) L.geoJSON(isochronePolygon, {style: {color: color, fillOpacity: 0.15}}).addTo(map);

            let validCount = 0;
            const cities = Array.from(communesMap.keys());
            const duration = parseInt(document.getElementById('duration').value);
            // Tol√©rance max : on accepte tout ce qui est dans le polygone √©largi (donc jusqu'√† +15% de temps)
            // Pour la distance de sauvetage hors-polygone, on met le paquet : 
            const speedFactor = avoidTolls ? 1.0 : 1.4; 
            const maxDistKm = (duration * 1.15) * speedFactor; // Dur√©e + 15% convertie en km

            log(`Analyse g√©ographique (${cities.length} villes)...`);

            for (const city of cities) {
                try {
                    const geo = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(city + ", France")}&format=json&limit=1`).then(r => r.json());
                    if (geo.length) {
                        const lat = parseFloat(geo[0].lat);
                        const lon = parseFloat(geo[0].lon);
                        const pt = turf.point([lon, lat]);
                        
                        const from = turf.point([startLon, startLat]);
                        const distKm = turf.distance(from, pt, {units: 'kilometers'});

                        // TEST INCLUSION (Dans la zone √©largie de 15%)
                        let isInside = false;
                        if (isochronePolygon) {
                            for (const feat of isochronePolygon.features) {
                                if (turf.booleanPointInPolygon(pt, feat)) { isInside = true; break; }
                            }
                        }

                        let isRescued = (!isInside && distKm < maxDistKm);

                        if (isInside || isRescued) {
                            validCount++;
                            // Si dans la zone, c'est OK ou Limite ? 
                            // Comme la zone est d√©j√† √©largie de 15%, on consid√®re que "Inside" = Dans la tol√©rance.
                            // Si c'est Rescued, c'est "Proche"
                            
                            let badge = isInside ? '<span class="badge-ok">‚úÖ Zone</span>' : '<span class="badge-warn">‚ö†Ô∏è Proche</span>';
                            
                            // Petit bonus : si c'est tr√®s loin (> 120km pour 90min), on met un badge bleu "Limite"
                            if (distKm > (duration * speedFactor)) badge = '<span class="badge-lim">‚è±Ô∏è Limite</span>';

                            const li = document.createElement('li');
                            li.innerHTML = `
                                <div><div style="font-weight:700;">${city} ${badge}</div><div style="color:#666; font-size:0.85em;">${communesMap.get(city)} annonces ‚Ä¢ ${Math.round(distKm)} km</div></div>
                                <button class="btn-see" onclick="showDetails('${city.replace(/'/g, "\\'")}')">Voir</button>
                            `;
                            document.getElementById('results-list').appendChild(li);
                            L.marker([lat, lon]).addTo(map).bindPopup(`<b>${city}</b>`);
                        }
                    }
                } catch (e) {}
                if (cities.indexOf(city) % 5 === 0) await new Promise(r => setTimeout(r, 10));
            }
            document.getElementById('final-count').innerText = validCount;
            log(`Termin√© !`, "success");

        } catch (e) { log(e.message, "error"); }
        btn.disabled = false;
    }
</script>

</body>
</html>
