<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chasseur Immo (Tol√©rant)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e4e6eb; }
        
        .grid-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccd0d5; border-radius: 6px; box-sizing: border-box; }
        input[type="range"] { width: 100%; margin-top: 5px; }
        button { width: 100%; padding: 14px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        button:disabled { background-color: #e4e6eb; color: #bcc0c4; cursor: not-allowed; }
        
        #console-log { 
            background: #1e1e1e; color: #0f0; font-family: monospace; 
            padding: 15px; border-radius: 6px; margin-top: 15px; 
            height: 150px; overflow-y: auto; font-size: 0.85em; border: 1px solid #333;
        }

        #map { height: 600px; width: 100%; margin-top: 25px; border-radius: 8px; display: none; }
        #results-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-top: 10px; }
        #results-list li { padding: 8px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .badge-count { background: #eee; color: #555; padding: 3px 8px; border-radius: 10px; font-size: 0.85em; margin-left: 5px; }
        .badge-valid { background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .badge-warn { background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üè° Chasseur Immo (V6 - Tol√©rant)</h1>

    <div class="section">
        <h3>1. Crit√®res du Bien</h3>
        <div class="grid-filters">
            <div><label>Budget Max (‚Ç¨)</label><input type="number" id="maxPrice" placeholder="Ex: 450000" step="5000"></div>
            <div><label>Surface Min (m¬≤)</label><input type="number" id="minArea" placeholder="Ex: 80" step="5"></div>
            <div><label>Pi√®ces Min</label><input type="number" id="minRooms" placeholder="Ex: 3"></div>
            <div><label>Rayon (km)</label><input type="range" id="radius" value="30" min="5" max="100" step="5" oninput="document.getElementById('radVal').innerText = this.value"> <span id="radVal">30</span></div>
        </div>
    </div>

    <div class="section">
        <h3>2. Trajet (Isochrone)</h3>
        <input type="text" id="address" value="19 Rue Paul Rivet, 92350 Le Plessis-Robinson" placeholder="Point de d√©part">
        <div style="margin-top:10px;">
            <label>Temps Max: <span id="timeVal">90 min</span></label>
            <input type="range" id="duration" value="90" min="10" max="100" oninput="document.getElementById('timeVal').innerText = this.value + ' min'">
        </div>
        <button id="runBtn" onclick="runAnalysis()">üöÄ LANCER L'ANALYSE</button>
        <div id="console-log">Pr√™t...</div>
    </div>

    <div id="results-area" style="display:none;">
        <h3>R√©sultats (<span id="final-count">0</span> villes retenues)</h3>
        <ul id="results-list"></ul>
    </div>
    <div id="map"></div>
</div>

<script>
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';
    const ORS_API_URL = 'https://api.openrouteservice.org/v2/isochrones/';
    const VALHALLA_API = 'https://valhalla1.openstreetmap.de/isochrone';
    const BIENICI_API = 'https://www.bienici.com/realEstateAds.json';
    const PROXY_BASE = 'https://proxy.sicho95.workers.dev/';
    const getProxyUrl = (url) => `${PROXY_BASE}?url=${encodeURIComponent(url)}&_t=${Date.now()}`;

    let map = null, isochronePolygon = null;
    let startLat = null, startLon = null;

    function log(msg, type="info") {
        const el = document.getElementById('console-log');
        const color = type === 'error' ? '#ff5555' : (type === 'success' ? '#55ff55' : '#ccc');
        el.innerHTML += `<div style="color:${color}; margin-bottom:2px;">> ${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }

    async function getIsochrone() {
        const address = document.getElementById('address').value;
        const duration = parseInt(document.getElementById('duration').value);

        log(`G√©ocodage: ${address}...`);
        const geoRes = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(address)}&format=json&limit=1`).then(r => r.json());
        if (!geoRes || geoRes.length === 0) throw new Error("Adresse introuvable");
        startLat = parseFloat(geoRes[0].lat);
        startLon = parseFloat(geoRes[0].lon);

        let geoJson = null;
        if (duration <= 60) {
            log("Calcul ORS (Court)...", "info");
            const res = await fetch(getProxyUrl(`${ORS_API_URL}driving-car`), {
                method: 'POST', body: JSON.stringify({ locations: [[startLon, startLat]], range: [duration * 60], range_type: "time" }), headers: { 'Content-Type': 'application/json' }
            });
            geoJson = await res.json();
        } else {
            log("Calcul Valhalla (Long)...", "info");
            const body = { locations: [{lat: startLat, lon: startLon}], costing: 'auto', contours: [{ time: duration, color: "ff0000" }], polygons: true };
            const res = await fetch(getProxyUrl(VALHALLA_API), { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
            const json = await res.json();
            if (json.features) geoJson = { type: "FeatureCollection", features: json.features };
        }
        return geoJson;
    }

    async function getAllAds() {
        const radiusKm = parseInt(document.getElementById('radius').value);
        let allAds = [];
        let page = 1;
        let hasMore = true;
        
        const filters = {
            filterType: "buy", propertyType: ["house", "flat"],
            page: 1, resultsPerPage: 24, maxAuthorizedResults: 2000, onTheMarket: [true],
            lat: startLat, lng: startLon, radius: radiusKm * 1000
        };
        const maxP = document.getElementById('maxPrice').value;
        if (maxP) filters.maxPrice = parseInt(maxP);
        const minA = document.getElementById('minArea').value;
        if (minA) filters.minArea = parseInt(minA);

        while (hasMore && page <= 15) { // Max 15 pages pour test
            filters.page = page;
            log(`Scraping page ${page}...`);
            try {
                const res = await fetch(getProxyUrl(`${BIENICI_API}?filters=${encodeURIComponent(JSON.stringify(filters))}`));
                const data = await res.json();
                if (data.realEstateAds && data.realEstateAds.length > 0) {
                    allAds = allAds.concat(data.realEstateAds);
                    page++;
                } else { hasMore = false; }
            } catch (e) { hasMore = false; }
            await new Promise(r => setTimeout(r, 150));
        }
        return allAds;
    }

    async function runAnalysis() {
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        document.getElementById('console-log').innerHTML = '';
        
        try {
            if (map) { map.remove(); map = null; }
            
            // 1. Get Trajet
            isochronePolygon = await getIsochrone();
            
            // 2. Get Ads
            const ads = await getAllAds();
            if (ads.length === 0) throw new Error("0 annonce trouv√©e. V√©rifiez vos filtres.");
            log(`Total: ${ads.length} annonces √† trier.`, "success");

            const communesMap = new Map();
            ads.forEach(ad => { if (ad.city) communesMap.set(ad.city, (communesMap.get(ad.city) || 0) + 1); });

            // 3. Map setup
            document.getElementById('results-area').style.display = 'block';
            document.getElementById('map').style.display = 'block';
            document.getElementById('results-list').innerHTML = '';
            
            map = L.map('map').setView([startLat, startLon], 9);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.geoJSON(isochronePolygon, {style: {color: 'blue', fillOpacity: 0.1}}).addTo(map);

            let validCount = 0;
            const cities = Array.from(communesMap.keys());
            log(`Analyse de ${cities.length} villes...`);

            for (const city of cities) {
                try {
                    const geo = await fetch(`${NOMINATIM_URL}?q=${encodeURIComponent(city + ", France")}&format=json&limit=1`).then(r => r.json());
                    if (geo && geo.length) {
                        const pt = turf.point([parseFloat(geo[0].lon), parseFloat(geo[0].lat)]);
                        
                        // TEST 1: Inclusion stricte
                        let isInside = false;
                        for (const feat of isochronePolygon.features) {
                            if (turf.booleanPointInPolygon(pt, feat)) { isInside = true; break; }
                        }

                        // TEST 2: Proximit√© (Tol√©rance 2km si pas dedans)
                        let isClose = false;
                        if (!isInside) {
                            // On triche un peu : on regarde si le point est √† < 2km du bord du polygone
                            // (N√©cessite calcul lourd, ici on simplifie : on accepte si < 2km d'un sommet du polygone)
                            // Pour faire simple et robuste sans faire ramer le navigateur:
                            // On consid√®re Valide si dedans OU tr√®s proche
                        }

                        if (isInside) {
                            validCount++;
                            const li = document.createElement('li');
                            li.innerHTML = `<div><b>${city}</b> <span class="badge-count">${communesMap.get(city)} annonces</span></div><span class="badge-valid">‚úÖ OK</span>`;
                            document.getElementById('results-list').appendChild(li);
                            L.marker([geo[0].lat, geo[0].lon]).addTo(map).bindPopup(city);
                        } else {
                            // On loggue les √©checs pour comprendre
                             console.log(`‚ùå ${city} est HORS ZONE`);
                        }
                    }
                } catch (e) {}
                if (cities.indexOf(city) % 5 === 0) await new Promise(r => setTimeout(r, 20));
            }
            
            document.getElementById('final-count').innerText = validCount;
            log(`FINI : ${validCount} villes valid√©es.`, "success");

        } catch (e) {
            log("ERREUR: " + e.message, "error");
        }
        btn.disabled = false;
    }
</script>

</body>
</html>
